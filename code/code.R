# https://www.kaggle.com/c/house-prices-advanced-regression-techniques/
# the goal is to predict house prices

# load packages
library(tidyverse)
library(tidymodels)
library(corrplot)
library(modelStudio)
library(DALEX)
library(Metrics)

# read data from github
train <- read.csv('https://raw.githubusercontent.com/wsamuelw/kaggle-predict-house-prices/main/data/train.csv', stringsAsFactors = T); nrow(train) # 1460
test <- read.csv('https://raw.githubusercontent.com/wsamuelw/kaggle-predict-house-prices/main/data/test.csv', stringsAsFactors = T); nrow(test) # 1459

# create SalePrice in the test set
test$SalePrice <- NA

# combine both train and test sets into one dataframe
full <- rbind(train, test); nrow(full) # 2919

# drop the ID column
# full$Id <- NULL

glimpse(full)

# Rows: 2,919
# Columns: 81
# $ Id            <int> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29,…
# $ MSSubClass    <int> 60, 20, 60, 70, 60, 50, 20, 60, 50, 190, 20, 60, 20, 20, 20, 45, 20, 90, 20, 20, 60, 45, 20, 120, 20, 20, …
# $ MSZoning      <fct> RL, RL, RL, RL, RL, RL, RL, RL, RM, RL, RL, RL, RL, RL, RL, RM, RL, RL, RL, RL, RL, RM, RL, RM, RL, RL, RL…
# $ LotFrontage   <int> 65, 80, 68, 60, 84, 85, 75, NA, 51, 50, 70, 85, NA, 91, NA, 51, NA, 72, 66, 70, 101, 57, 75, 44, NA, 110, …
# $ LotArea       <int> 8450, 9600, 11250, 9550, 14260, 14115, 10084, 10382, 6120, 7420, 11200, 11924, 12968, 10652, 10920, 6120, …
# $ Street        <fct> Pave, Pave, Pave, Pave, Pave, Pave, Pave, Pave, Pave, Pave, Pave, Pave, Pave, Pave, Pave, Pave, Pave, Pave…
# $ Alley         <fct> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, Grvl, NA, NA, NA, NA, …
# $ LotShape      <fct> Reg, Reg, IR1, IR1, IR1, IR1, Reg, IR1, Reg, Reg, Reg, IR1, IR2, IR1, IR1, Reg, IR1, Reg, Reg, Reg, IR1, R…
# $ LandContour   <fct> Lvl, Lvl, Lvl, Lvl, Lvl, Lvl, Lvl, Lvl, Lvl, Lvl, Lvl, Lvl, Lvl, Lvl, Lvl, Lvl, Lvl, Lvl, Lvl, Lvl, Lvl, B…
# $ Utilities     <fct> AllPub, AllPub, AllPub, AllPub, AllPub, AllPub, AllPub, AllPub, AllPub, AllPub, AllPub, AllPub, AllPub, Al…
# $ LotConfig     <fct> Inside, FR2, Inside, Corner, FR2, Inside, Inside, Corner, Inside, Corner, Inside, Inside, Inside, Inside, …
# $ LandSlope     <fct> Gtl, Gtl, Gtl, Gtl, Gtl, Gtl, Gtl, Gtl, Gtl, Gtl, Gtl, Gtl, Gtl, Gtl, Gtl, Gtl, Gtl, Gtl, Gtl, Gtl, Gtl, G…
# $ Neighborhood  <fct> CollgCr, Veenker, CollgCr, Crawfor, NoRidge, Mitchel, Somerst, NWAmes, OldTown, BrkSide, Sawyer, NridgHt, …
# $ Condition1    <fct> Norm, Feedr, Norm, Norm, Norm, Norm, Norm, PosN, Artery, Artery, Norm, Norm, Norm, Norm, Norm, Norm, Norm,…
# $ Condition2    <fct> Norm, Norm, Norm, Norm, Norm, Norm, Norm, Norm, Norm, Artery, Norm, Norm, Norm, Norm, Norm, Norm, Norm, No…
# $ BldgType      <fct> 1Fam, 1Fam, 1Fam, 1Fam, 1Fam, 1Fam, 1Fam, 1Fam, 1Fam, 2fmCon, 1Fam, 1Fam, 1Fam, 1Fam, 1Fam, 1Fam, 1Fam, Du…
# $ HouseStyle    <fct> 2Story, 1Story, 2Story, 2Story, 2Story, 1.5Fin, 1Story, 2Story, 1.5Fin, 1.5Unf, 1Story, 2Story, 1Story, 1S…
# $ OverallQual   <int> 7, 6, 7, 7, 8, 5, 8, 7, 7, 5, 5, 9, 5, 7, 6, 7, 6, 4, 5, 5, 8, 7, 8, 5, 5, 8, 5, 8, 5, 4, 4, 5, 8, 5, 9, 8…
# $ OverallCond   <int> 5, 8, 5, 5, 5, 5, 5, 6, 5, 6, 5, 5, 6, 5, 5, 8, 7, 5, 5, 6, 5, 7, 5, 7, 8, 5, 7, 5, 6, 6, 4, 6, 5, 5, 5, 5…
# $ YearBuilt     <int> 2003, 1976, 2001, 1915, 2000, 1993, 2004, 1973, 1931, 1939, 1965, 2005, 1962, 2006, 1960, 1929, 1970, 1967…
# $ YearRemodAdd  <int> 2003, 1976, 2002, 1970, 2000, 1995, 2005, 1973, 1950, 1950, 1965, 2006, 1962, 2007, 1960, 2001, 1970, 1967…
# $ RoofStyle     <fct> Gable, Gable, Gable, Gable, Gable, Gable, Gable, Gable, Gable, Gable, Hip, Hip, Hip, Gable, Hip, Gable, Ga…
# $ RoofMatl      <fct> CompShg, CompShg, CompShg, CompShg, CompShg, CompShg, CompShg, CompShg, CompShg, CompShg, CompShg, CompShg…
# $ Exterior1st   <fct> VinylSd, MetalSd, VinylSd, Wd Sdng, VinylSd, VinylSd, VinylSd, HdBoard, BrkFace, MetalSd, HdBoard, WdShing…
# $ Exterior2nd   <fct> VinylSd, MetalSd, VinylSd, Wd Shng, VinylSd, VinylSd, VinylSd, HdBoard, Wd Shng, MetalSd, HdBoard, Wd Shng…
# $ MasVnrType    <fct> BrkFace, None, BrkFace, None, BrkFace, None, Stone, Stone, None, None, None, Stone, None, Stone, BrkFace, …
# $ MasVnrArea    <int> 196, 0, 162, 0, 350, 0, 186, 240, 0, 0, 0, 286, 0, 306, 212, 0, 180, 0, 0, 0, 380, 0, 281, 0, 0, 640, 0, 2…
# $ ExterQual     <fct> Gd, TA, Gd, TA, Gd, TA, Gd, TA, TA, TA, TA, Ex, TA, Gd, TA, TA, TA, TA, TA, TA, Gd, TA, Gd, TA, TA, Gd, TA…
# $ ExterCond     <fct> TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, Gd, TA, TA…
# $ Foundation    <fct> PConc, CBlock, PConc, BrkTil, PConc, Wood, PConc, CBlock, BrkTil, BrkTil, CBlock, PConc, CBlock, PConc, CB…
# $ BsmtQual      <fct> Gd, Gd, Gd, TA, Gd, Gd, Ex, Gd, TA, TA, TA, Ex, TA, Gd, TA, TA, TA, NA, TA, TA, Ex, TA, Gd, Gd, TA, Gd, TA…
# $ BsmtCond      <fct> TA, TA, TA, Gd, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, NA, TA, TA, TA, TA, TA, TA, TA, TA, TA…
# $ BsmtExposure  <fct> No, Gd, Mn, No, Av, No, Av, Mn, No, No, No, No, No, Av, No, No, No, NA, No, No, Av, No, No, No, Mn, No, Mn…
# $ BsmtFinType1  <fct> GLQ, ALQ, GLQ, ALQ, GLQ, GLQ, GLQ, ALQ, Unf, GLQ, Rec, GLQ, ALQ, Unf, BLQ, Unf, ALQ, NA, GLQ, LwQ, Unf, Un…
# $ BsmtFinSF1    <int> 706, 978, 486, 216, 655, 732, 1369, 859, 0, 851, 906, 998, 737, 0, 733, 0, 578, 0, 646, 504, 0, 0, 0, 840,…
# $ BsmtFinType2  <fct> Unf, Unf, Unf, Unf, Unf, Unf, Unf, BLQ, Unf, Unf, Unf, Unf, Unf, Unf, Unf, Unf, Unf, NA, Unf, Unf, Unf, Un…
# $ BsmtFinSF2    <int> 0, 0, 0, 0, 0, 0, 0, 32, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 668, 0, 486, 0, 0, 0, 0, 0, 0, 0,…
# $ BsmtUnfSF     <int> 150, 284, 434, 540, 490, 64, 317, 216, 952, 140, 134, 177, 175, 1494, 520, 832, 426, 0, 468, 525, 1158, 63…
# $ TotalBsmtSF   <int> 856, 1262, 920, 756, 1145, 796, 1686, 1107, 952, 991, 1040, 1175, 912, 1494, 1253, 832, 1004, 0, 1114, 102…
# $ Heating       <fct> GasA, GasA, GasA, GasA, GasA, GasA, GasA, GasA, GasA, GasA, GasA, GasA, GasA, GasA, GasA, GasA, GasA, GasA…
# $ HeatingQC     <fct> Ex, Ex, Ex, Gd, Ex, Ex, Ex, Ex, Gd, Ex, Ex, Ex, TA, Ex, TA, Ex, Ex, TA, Ex, TA, Ex, Ex, Ex, TA, Ex, Ex, TA…
# $ CentralAir    <fct> Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, N, N, Y, Y, Y, Y, Y…
# $ Electrical    <fct> SBrkr, SBrkr, SBrkr, SBrkr, SBrkr, SBrkr, SBrkr, SBrkr, FuseF, SBrkr, SBrkr, SBrkr, SBrkr, SBrkr, SBrkr, F…
# $ X1stFlrSF     <int> 856, 1262, 920, 961, 1145, 796, 1694, 1107, 1022, 1077, 1040, 1182, 912, 1494, 1253, 854, 1004, 1296, 1114…
# $ X2ndFlrSF     <int> 854, 0, 866, 756, 1053, 566, 0, 983, 752, 0, 0, 1142, 0, 0, 0, 0, 0, 0, 0, 0, 1218, 0, 0, 0, 0, 0, 0, 0, 0…
# $ LowQualFinSF  <int> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ GrLivArea     <int> 1710, 1262, 1786, 1717, 2198, 1362, 1694, 2090, 1774, 1077, 1040, 2324, 912, 1494, 1253, 854, 1004, 1296, …
# $ BsmtFullBath  <int> 1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0…
# $ BsmtHalfBath  <int> 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0…
# $ FullBath      <int> 2, 2, 2, 1, 2, 1, 2, 2, 2, 1, 1, 3, 1, 2, 1, 1, 1, 2, 1, 1, 3, 1, 2, 1, 1, 2, 1, 2, 1, 1, 1, 1, 2, 1, 2, 3…
# $ HalfBath      <int> 1, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1…
# $ BedroomAbvGr  <int> 3, 3, 3, 3, 4, 1, 3, 3, 2, 2, 3, 4, 2, 3, 2, 2, 2, 2, 3, 3, 4, 3, 3, 3, 3, 3, 3, 3, 2, 1, 3, 3, 3, 4, 2, 4…
# $ KitchenAbvGr  <int> 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
# $ KitchenQual   <fct> Gd, TA, Gd, Gd, Gd, TA, Gd, TA, TA, TA, TA, Ex, TA, Gd, TA, TA, TA, TA, Gd, TA, Gd, Gd, Gd, TA, Gd, Gd, Gd…
# $ TotRmsAbvGrd  <int> 8, 6, 6, 7, 9, 5, 7, 7, 8, 5, 5, 11, 4, 7, 5, 5, 5, 6, 6, 6, 9, 6, 7, 6, 6, 7, 5, 7, 6, 4, 6, 6, 7, 6, 6, …
# $ Functional    <fct> Typ, Typ, Typ, Typ, Typ, Typ, Typ, Typ, Min1, Typ, Typ, Typ, Typ, Typ, Typ, Typ, Typ, Typ, Typ, Min1, Typ,…
# $ Fireplaces    <int> 0, 1, 1, 1, 1, 0, 1, 2, 2, 2, 0, 2, 0, 1, 1, 0, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 2, 0, 0, 0, 0, 1, 1, 1…
# $ FireplaceQu   <fct> NA, TA, TA, Gd, TA, NA, Gd, TA, TA, TA, NA, Gd, NA, Gd, Fa, NA, TA, NA, NA, NA, Gd, Gd, Gd, TA, TA, Gd, NA…
# $ GarageType    <fct> Attchd, Attchd, Attchd, Detchd, Attchd, Attchd, Attchd, Attchd, Detchd, Attchd, Detchd, BuiltIn, Detchd, A…
# $ GarageYrBlt   <int> 2003, 1976, 2001, 1998, 2000, 1993, 2004, 1973, 1931, 1939, 1965, 2005, 1962, 2006, 1960, 1991, 1970, 1967…
# $ GarageFinish  <fct> RFn, RFn, RFn, Unf, RFn, Unf, RFn, RFn, Unf, RFn, Unf, Fin, Unf, RFn, RFn, Unf, Fin, Unf, Unf, Unf, RFn, U…
# $ GarageCars    <int> 2, 2, 2, 3, 3, 2, 2, 2, 2, 1, 1, 3, 1, 3, 1, 2, 2, 2, 2, 1, 3, 1, 2, 2, 1, 3, 2, 3, 1, 1, 1, 1, 2, 2, 2, 3…
# $ GarageArea    <int> 548, 460, 608, 642, 836, 480, 636, 484, 468, 205, 384, 736, 352, 840, 352, 576, 480, 516, 576, 294, 853, 2…
# $ GarageQual    <fct> TA, TA, TA, TA, TA, TA, TA, TA, Fa, Gd, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA…
# $ GarageCond    <fct> TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA, TA…
# $ PavedDrive    <fct> Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, Y, N, Y, Y, Y, Y, Y, Y, Y, Y, N, Y, Y, Y, Y, Y…
# $ WoodDeckSF    <int> 0, 298, 0, 0, 192, 40, 255, 235, 90, 0, 0, 147, 140, 160, 0, 48, 0, 0, 0, 0, 240, 0, 171, 100, 406, 0, 222…
# $ OpenPorchSF   <int> 61, 0, 42, 35, 84, 30, 57, 204, 0, 4, 0, 21, 0, 33, 213, 112, 0, 0, 102, 0, 154, 0, 159, 110, 90, 56, 32, …
# $ EnclosedPorch <int> 0, 0, 0, 272, 0, 0, 0, 228, 205, 0, 0, 0, 0, 0, 176, 0, 0, 0, 0, 0, 0, 205, 0, 0, 0, 0, 0, 0, 0, 87, 172, …
# $ X3SsnPorch    <int> 0, 0, 0, 0, 0, 320, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
# $ ScreenPorch   <int> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 176, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
# $ PoolArea      <int> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ PoolQC        <fct> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
# $ Fence         <fct> NA, NA, NA, NA, NA, MnPrv, NA, NA, NA, NA, NA, NA, NA, NA, GdWo, GdPrv, NA, NA, NA, MnPrv, NA, GdPrv, NA, …
# $ MiscFeature   <fct> NA, NA, NA, NA, NA, Shed, NA, Shed, NA, NA, NA, NA, NA, NA, NA, NA, Shed, Shed, NA, NA, NA, NA, NA, NA, NA…
# $ MiscVal       <int> 0, 0, 0, 0, 0, 700, 0, 350, 0, 0, 0, 0, 0, 0, 0, 0, 700, 500, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
# $ MoSold        <int> 2, 5, 9, 2, 12, 10, 8, 11, 4, 1, 2, 7, 9, 8, 5, 7, 3, 10, 6, 5, 11, 6, 9, 6, 5, 7, 5, 5, 12, 5, 7, 6, 1, 4…
# $ YrSold        <int> 2008, 2007, 2008, 2006, 2008, 2009, 2007, 2009, 2008, 2008, 2008, 2006, 2008, 2007, 2008, 2007, 2010, 2006…
# $ SaleType      <fct> WD, WD, WD, WD, WD, WD, WD, WD, WD, WD, WD, New, WD, New, WD, WD, WD, WD, WD, COD, New, WD, WD, WD, WD, WD…
# $ SaleCondition <fct> Normal, Normal, Normal, Abnorml, Normal, Normal, Normal, Normal, Abnorml, Normal, Normal, Partial, Normal,…
# $ SalePrice     <int> 208500, 181500, 223500, 140000, 250000, 143000, 307000, 200000, 129900, 118000, 129500, 345000, 144000, 27…

View(full)

# visualise missing data
DataExplorer::plot_missing(full, missing_only = T)

# quickly remove all features below with too many missing values
full_cleaned <- full %>% 
  select(-FireplaceQu, -Fence, -Alley, -MiscFeature, -PoolQC)

DataExplorer::plot_missing(full_cleaned, missing_only = T)

# split full into train and unseen
train_cleaned <- full_cleaned %>% 
  filter(!is.na(SalePrice)); nrow(train_cleaned) # 1460

unseen_cleaned <- full_cleaned %>% 
  filter(is.na(SalePrice)); nrow(unseen_cleaned) # 1459

# split the train set into train and test
set.seed(222) 
house_split <- initial_split(train_cleaned, prop = 0.8, strata = SalePrice) # enforce similar distributions
house_split

# <Analysis/Assess/Total>
# <1166/294/1460>

house_train <- training(house_split); nrow(house_train) # 1166
house_test <- testing(house_split); nrow(house_test) # 294

# define engine for regression using xgboost
model_spec <- boost_tree() %>% 
  set_engine("xgboost") %>% 
  set_mode("regression")

model_spec

# Fit to the data
# *one observation = cannot have features with too many missing values
model_fit <- model_spec %>%
  fit(formula = SalePrice ~ . -Id, data = house_train)

model_fit

# make predictions using the test set
predictions <- predict(model_fit, house_test) %>%
  bind_cols(house_test) # Add the test set

# create an explainer using the test set
explainer <- DALEX::explain(
  model = model_fit,
  data = house_test,
  y = house_test$SalePrice,
  label = "XGBoost"
)

# create a subset of a predictions using a sample of 5
pred_size_s <- predictions %>% 
  sample_n(5)

# s for size S
pred_size_s %>% 
  select(Id, .pred, SalePrice)

# Id   .pred SalePrice
# <int>   <dbl>     <int>
# 1   641 276033.    274000
# 2   711  91053.     52000
# 3  1388 173678.    136000
# 4  1188 305580.    262000
# 5  1434 177981.    186500

# create modelStudio
# need to explore the function more to learn more
# it takes a long time to create the report
modelStudio(explainer,
            pred_size_s, # use a much smaller dataset for this
            N = 200, # default = 300
            B = 5) # default = 10

# evaluation metrics
# r2
yardstick::rsq(predictions, estimate = .pred, truth = SalePrice) # 0.865

# mae
yardstick::mae(predictions, estimate = .pred, truth = SalePrice) # 18494

# rmse
yardstick::rmse(predictions, estimate = .pred, truth = SalePrice) # 26430

# using the Metrics package
# rmsle
Metrics::rmsle(predictions$SalePrice, predictions$.pred) # 0.1512431
Metrics::rmse(predictions$SalePrice, predictions$.pred) # 26429.85
Metrics::mae(predictions$SalePrice, predictions$.pred) # 18494.34

# now, make predictions using the unseen data
unseen_predictions <- predict(model_fit, unseen_cleaned) %>%
  bind_cols(unseen_cleaned) # Add the test set

unseen_predictions %>% 
  select(Id, .pred) %>% 
  sample_n(5)

# Id   .pred
# <int>   <dbl>
# 1  2130 140402.
# 2  1731 115558.
# 3  2918 134256.
# 4  2267 352237.
# 5  2245  80163.

# make a submission for kaggle
submission <- unseen_predictions %>% 
  select(Id, .pred) %>% 
  rename(SalePrice = .pred)

head(submission)

# export submission
write.csv(submission, "submission.csv", row.names = FALSE)

